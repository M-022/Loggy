<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wicked Log Road - By Yasmin and Samuel üë†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-dark: #040b05;
      --bg-panel: #102015;
      --bg-panel-alt: #13271a;
      --accent-yellow: #f4d97a;
      --accent-yellow-soft: #fff2b3;
      --accent-green: #2fbf71;     /* Elphaba / Emerald */
      --accent-emerald: #139f5b;
      --accent-pink: #f9a8d4;      /* Glinda pastel pink */
      --accent-rose: #fb7185;
      --accent-purple: #a855f7;
      --accent-red: #f56565;
      --text-main: #f9fafb;
      --text-muted: #a0aec0;
      --border-subtle: rgba(255,255,255,0.08);
      --brick-line: rgba(0,0,0,0.25);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #103d26 0%, #040b05 60%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
      /* Green wand cursor */
      cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Crect x='11' y='5' width='2' height='16' fill='%23139f5b'/%3E%3Ccircle cx='12' cy='5' r='3' fill='%23baf5d0'/%3E%3Cline x1='12' y1='0' x2='12' y2='3' stroke='%23e5fffb' stroke-width='1'/%3E%3Cline x1='9' y1='2' x2='11' y2='4' stroke='%23e5fffb' stroke-width='1'/%3E%3Cline x1='13' y1='4' x2='15' y2='2' stroke='%23e5fffb' stroke-width='1'/%3E%3C/svg%3E") 4 2, auto;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(
        to bottom,
        rgba(9, 40, 20, 0.95),
        rgba(8, 17, 12, 0.98)
      );
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow:
        0 30px 80px rgba(0,0,0,0.7),
        0 0 0 1px rgba(0,0,0,0.8);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(16px);
    }

    /* YELLOW BRICK BANNER HEADER */
    header.app-header {
      position: relative;
      padding: 18px 24px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.35);
      background:
        repeating-linear-gradient(
          -45deg,
          var(--accent-yellow-soft),
          var(--accent-yellow-soft) 18px,
          #f0d062 18px,
          #f0d062 21px
        );
      background-size: 140% 140%;
      animation: bricks-slow 30s linear infinite;
    }

    @keyframes bricks-slow {
      0% { background-position: 0% 0%; }
      100% { background-position: 100% 100%; }
    }

    /* Sparkly red shoe logo */
    .logo-circle {
      position: relative;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: radial-gradient(
        circle at 30% 20%,
        #fff7f7,
        #ff8ba7 35%,
        #ff003c 70%,
        #7a001c 100%
      );
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow:
        0 10px 20px rgba(0,0,0,0.4),
        0 0 0 3px rgba(0,0,0,0.25);
      overflow: hidden;
    }

    .logo-circle span {
      position: relative;
      z-index: 2;
    }

    /* Glistening sparkle overlay */
    .logo-circle::after {
      content: "‚ú®";
      position: absolute;
      top: 6px;
      left: -10px;
      font-size: 18px;
      opacity: 0;
      animation: sparkle 2.4s infinite ease-in-out;
    }

    @keyframes sparkle {
      0%   { transform: translateX(0) translateY(0); opacity: 0; }
      25%  { opacity: 1; }
      50%  { transform: translateX(36px) translateY(-6px); opacity: 0.8; }
      75%  { opacity: 0; }
      100% { transform: translateX(0) translateY(0); opacity: 0; }
    }

    .header-text h1 {
      margin: 0;
      font-size: 1.5rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #302109;
    }

    .header-text p {
      margin: 2px 0 0;
      font-size: 0.86rem;
      color: #5a4318;
      font-weight: 500;
    }

    /* Glinda + Elphaba orb */
    .header-orb {
      margin-left: auto;
      font-size: 30px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 999px;
      background: radial-gradient(circle at 0% 0%, #f9a8d4 0%, #22c55e 60%, #064e3b 100%);
      box-shadow:
        0 0 18px rgba(19,159,91,0.8),
        0 0 30px rgba(249,168,212,0.7);
    }

    .header-orb span.label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #fefce8;
    }

    main.app-main {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(260px, 0.9fr);
      gap: 0;
      min-height: 520px;
    }

    @media (max-width: 900px) {
      main.app-main {
        grid-template-columns: 1fr;
      }
    }

    .left-pane {
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(0,0,0,0.6);
      background:
        radial-gradient(circle at top left, rgba(33,115,70,0.35), rgba(4,7,5,0.98));
    }

    /* Right pane with subtle pink + green contrast (Glinda/Elphaba) */
    .right-pane {
      background:
        radial-gradient(circle at top right, rgba(249,168,212,0.16), transparent 45%),
        radial-gradient(circle at top left, rgba(34,197,94,0.18), transparent 60%),
        linear-gradient(to bottom, #020b06, #020705);
      padding: 16px 18px 18px;
    }

    .controls-bar {
      padding: 12px 18px;
      border-bottom: 1px solid rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(5,15,9,0.96);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .field-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .field-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    input[type="text"],
    select {
      background: rgba(0,0,0,0.5);
      border: 1px solid var(--border-subtle);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--text-main);
      font-size: 0.85rem;
      outline: none;
      min-width: 0;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent-emerald);
      box-shadow: 0 0 0 1px rgba(19,159,91,0.6);
    }

    input[type="file"] {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.7);
      padding: 6px 12px;
      font-size: 0.8rem;
      background: radial-gradient(circle at 20% 0, #ffeef9, #f9a8d4);
      color: #3b0714;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow:
        0 3px 8px rgba(0,0,0,0.55),
        0 0 0 1px rgba(255,255,255,0.16);
      white-space: nowrap;
    }

    .btn-secondary {
      background: linear-gradient(to bottom right, #12351f, #050c07);
      color: #e0ffe9;
      border-color: rgba(255,255,255,0.12);
      box-shadow:
        0 3px 8px rgba(0,0,0,0.6),
        0 0 0 1px rgba(0,0,0,0.9);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow:
        0 1px 4px rgba(0,0,0,0.7),
        0 0 0 1px rgba(255,255,255,0.2);
    }

    .btn-icon {
      font-size: 1rem;
    }

    .toggle-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 4px 9px;
      background: rgba(2,7,3,0.95);
      cursor: pointer;
    }

    .toggle-chip input {
      margin: 0;
    }

    .log-table-wrap {
      flex: 1;
      overflow: auto;
      padding: 10px 18px 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 5;
    }

    /* Emerald + warm yellow header */
    thead tr {
      background: linear-gradient(
        to right,
        rgba(16,95,48,0.95),
        rgba(244,217,122,0.9)
      );
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(0,0,0,0.6);
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #1f1303;
    }

    tbody tr {
      background: rgba(5,14,8,0.96);
      cursor: pointer;
      transition: background 0.15s ease, transform 0.06s ease;
    }

    tbody tr:nth-child(even) {
      background: rgba(8,21,11,0.98);
    }

    tbody tr:hover {
      background: rgba(21,69,37,0.98);
      transform: translateY(-1px);
    }

    tbody tr.selected {
      outline: 1px solid var(--accent-emerald);
      box-shadow: 0 0 0 1px rgba(19,159,91,0.9);
      position: relative;
    }

    tbody tr.selected::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(
        to bottom,
        var(--accent-emerald),
        var(--accent-pink)
      );
    }

    .level-pill {
      display: inline-flex;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .level-INFO {
      background: rgba(99,179,237,0.16);
      color: #90cdf4;
    }
    .level-WARN {
      background: rgba(237,173,62,0.18);
      color: #f6e05e;
    }
    .level-ERROR {
      background: rgba(245,101,101,0.18);
      color: #feb2b2;
    }
    .level-CRITICAL,
    .level-ALERT {
      background: rgba(254,178,178,0.25);
      color: #fed7d7;
      border: 1px solid rgba(245,101,101,0.7);
    }

    /* Base tag pill */
    .tag-pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 1px 7px;
      font-size: 0.7rem;
      margin-right: 4px;
      margin-bottom: 3px;
      background: rgba(22,101,52,0.4);
      color: #bbf7d0;
      border: 1px solid rgba(34,197,94,0.7);
    }

    /* Elphaba alignment (suspicious / bad) */
    .tag-elphaba {
      background: linear-gradient(135deg, #064e3b, #16a34a);
      color: #ecfdf5;
      border-color: #22c55e;
    }

    /* Glinda alignment (good / benign) */
    .tag-glinda {
      background: linear-gradient(135deg, #f9a8d4, #fb7185);
      color: #fff7fb;
      border-color: #f9a8d4;
    }

    .tag-pill span.remove {
      margin-left: 4px;
      cursor: pointer;
      opacity: 0.8;
    }

    .muted {
      color: var(--text-muted);
    }

    .right-pane-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .right-pane-header h2 {
      margin: 0;
      font-size: 0.98rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #fefcbf;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(4,12,7,0.95);
      color: var(--text-muted);
    }

    /* Detail card with pink-green line = Glinda/Elphaba */
    .detail-card {
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.8);
      background:
        linear-gradient(135deg, rgba(13,56,32,0.95), rgba(3,8,4,0.98));
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 140px;
      position: relative;
    }

    .detail-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 12px;
      right: 12px;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(
        to right,
        var(--accent-pink),
        var(--accent-emerald)
      );
      opacity: 0.9;
    }

    .detail-line {
      font-size: 0.8rem;
      display: flex;
      gap: 6px;
    }

    .detail-label {
      width: 82px;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      flex-shrink: 0;
    }

    .detail-value {
      flex: 1;
      word-break: break-word;
    }

    .detail-message {
      font-size: 0.82rem;
      line-height: 1.4;
      padding: 6px 8px;
      border-radius: 10px;
      background: radial-gradient(circle at top left, rgba(249,168,212,0.08), rgba(0,0,0,0.7));
      border: 1px solid rgba(0,0,0,0.7);
    }

    .tag-editor {
      margin-top: 6px;
      border-top: 1px dashed rgba(255,255,255,0.18);
      padding-top: 6px;
    }

    .tag-editor-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .tag-editor-row input[type="text"] {
      flex: 1;
      border-radius: 10px;
    }

    .helper-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 0.76rem;
    }

    .stats-bar span {
      color: var(--text-muted);
    }

    /* Yellow brick road strip at bottom */
    .brick-path {
      margin-top: 10px;
      border-radius: 999px;
      height: 18px;
      background:
        repeating-linear-gradient(
          90deg,
          var(--accent-yellow-soft),
          var(--accent-yellow-soft) 18px,
          #f2c94c 18px,
          #f2c94c 21px
        );
      box-shadow:
        0 0 0 1px var(--brick-line),
        0 6px 14px rgba(0,0,0,0.9);
      position: relative;
      overflow: hidden;
    }

    .brick-path::after {
      content: "üß±";
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      animation: brick-walk 11s linear infinite;
    }

    @keyframes brick-walk {
      0% { transform: translateX(0); }
      100% { transform: translateX(420px); }
    }

    .empty-state {
      font-size: 0.8rem;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.5);
      color: var(--text-muted);
      margin-top: 4px;
    }

    .pill-inline {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      padding: 1px 6px;
      font-size: 0.72rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-inline span {
      font-size: 0.9em;
    }

    .empty-row {
      text-align: center;
      padding: 12px 8px;
    }

    .upload-right {
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="logo-circle">
        <span>üë†</span>
      </div>
      <div class="header-text">
        <h1>Wicked Log Road</h1>
        <p>Follow the yellow brick road straight to the sketchy events.</p>
      </div>
      <div class="header-orb">
        üíö üßô‚Äç‚ôÄÔ∏è üíñ
        <span class="label">Elphaba √ó Glinda</span>
      </div>
    </header>

    <main class="app-main">
      <section class="left-pane">
        <div class="controls-bar">
          <div class="controls-row">
            <div class="field-group" style="flex:1">
              <span class="field-label">Search</span>
              <input id="searchInput" type="text" placeholder="user=root, ip:10.0.0.13, 'failed password'‚Ä¶" />
            </div>

            <div class="field-group">
              <span class="field-label">Level</span>
              <select id="levelFilter">
                <option value="ALL">All</option>
                <option value="INFO">Info</option>
                <option value="WARN">Warn</option>
                <option value="ERROR">Error</option>
                <option value="CRITICAL">Critical</option>
                <option value="ALERT">Alert</option>
              </select>
            </div>

            <div class="field-group">
              <span class="field-label">Tag</span>
              <select id="tagFilter">
                <option value="ALL">Any</option>
                <option value="Suspicious">Suspicious</option>
                <option value="Benign">Benign</option>
                <option value="Investigate">Investigate</option>
              </select>
            </div>
          </div>

          <div class="controls-row">
            <label class="toggle-chip">
              <input id="onlyTagged" type="checkbox" />
              <span>Only tagged</span>
            </label>

            <button id="sampleBtn" class="btn-secondary">
              <span class="btn-icon">‚ú®</span> Sample logs
            </button>

            <div class="field-group upload-right">
              <span class="field-label">Upload</span>
              <input id="fileInput" type="file" accept=".log,.txt,.jsonl,.json" />
            </div>
          </div>
        </div>

        <div class="log-table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:150px;">Timestamp</th>
                <th style="width:80px;">Level</th>
                <th style="width:120px;">Source</th>
                <th>Message</th>
                <th style="width:140px;">Tags</th>
              </tr>
            </thead>
            <tbody id="logTableBody">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>
      </section>

      <aside class="right-pane">
        <div class="right-pane-header">
          <h2>Event Details</h2>
          <span id="selectionBadge" class="badge">No event selected</span>
        </div>

        <div class="detail-card" id="detailCard">
          <div class="empty-state" id="emptyState">
            Tap a row on the left to see the full event here, then tag the wicked
            ones like
            <span class="pill-inline"><span>üßô‚Äç‚ôÄÔ∏è</span> Suspicious</span> or
            bless the good ones
            <span class="pill-inline"><span>‚ú®</span> Benign</span>.
          </div>

          <div id="detailContent" style="display:none;">
            <div class="detail-line">
              <div class="detail-label">Time</div>
              <div class="detail-value" id="detailTime"></div>
            </div>
            <div class="detail-line">
              <div class="detail-label">Level</div>
              <div class="detail-value" id="detailLevel"></div>
            </div>
            <div class="detail-line">
              <div class="detail-label">Source</div>
              <div class="detail-value" id="detailSource"></div>
            </div>
            <div class="detail-line">
              <div class="detail-label">Category</div>
              <div class="detail-value" id="detailCategory"></div>
            </div>
            <div class="detail-line">
              <div class="detail-label">Message</div>
              <div class="detail-value">
                <div class="detail-message" id="detailMessage"></div>
              </div>
            </div>

            <div class="tag-editor">
              <div class="detail-line">
                <div class="detail-label">Tags</div>
                <div class="detail-value">
                  <div id="detailTags"></div>
                </div>
              </div>
              <div class="tag-editor-row">
                <input id="tagInput" type="text" placeholder="Add tag (e.g. 'Suspicious', 'Brute-force')" />
                <button id="addTagBtn" class="btn" style="padding-inline:10px;">
                  <span class="btn-icon">‚ûï</span> Add
                </button>
              </div>
              <p class="helper-text">
                Press Enter to add a tag. Remove tags by clicking the ‚úï.
              </p>
            </div>
          </div>

          <div class="stats-bar">
            <span id="statsLeft">0 events</span>
            <span id="statsRight">0 suspicious on the road</span>
          </div>
        </div>

        <div class="brick-path"></div>
      </aside>
    </main>
  </div>

  <script>
    const SAMPLE_LOGS = [
      {
        id: "s1",
        timestamp: "2025-12-10T13:31:02Z",
        level: "WARN",
        source: "auth.log",
        category: "Authentication",
        message: "Failed password for invalid user admin from 203.0.113.42 port 45210 ssh2",
        tags: ["Suspicious"]
      },
      {
        id: "s2",
        timestamp: "2025-12-10T13:31:08Z",
        level: "WARN",
        source: "auth.log",
        category: "Authentication",
        message: "Failed password for invalid user root from 203.0.113.42 port 45212 ssh2",
        tags: ["Suspicious", "Brute-force"]
      },
      {
        id: "s3",
        timestamp: "2025-12-10T13:31:23Z",
        level: "INFO",
        source: "nginx",
        category: "Web",
        message: '200 GET /index.html 192.0.2.10 "Mozilla/5.0"',
        tags: []
      },
      {
        id: "s4",
        timestamp: "2025-12-10T13:31:27Z",
        level: "ERROR",
        source: "nginx",
        category: "Web",
        message: '500 POST /api/login 198.51.100.77 "sqlmap/1.6.12" payload="\' OR 1=1--"',
        tags: ["Suspicious", "SQLi"]
      },
      {
        id: "s5",
        timestamp: "2025-12-10T13:31:40Z",
        level: "INFO",
        source: "windows-event",
        category: "Authentication",
        message: "Audit Success: User logon. Account Name: HANIN-LAPTOP\\\\yasmin, Logon Type: 2, Source Network Address: ::1",
        tags: ["Benign"]
      },
      {
        id: "s6",
        timestamp: "2025-12-10T13:32:05Z",
        level: "ALERT",
        source: "ids",
        category: "Network",
        message: "Multiple authentication failures for user 'service-account' from 203.0.113.42 detected within 60 seconds (threshold=5)",
        tags: ["Suspicious", "Investigate"]
      },
      {
        id: "s7",
        timestamp: "2025-12-10T13:33:20Z",
        level: "CRITICAL",
        source: "cloud-audit",
        category: "IAM",
        message: "IAM policy updated: user 'temp-admin' attached role 'AdministratorAccess' from unknown IP 198.51.100.99",
        tags: ["Suspicious", "Privilege escalation"]
      },
      {
        id: "s8",
        timestamp: "2025-12-10T13:35:00Z",
        level: "INFO",
        source: "vpn",
        category: "Remote Access",
        message: "VPN connection established: user=doctor.miller, ip=10.10.10.54, location=GBR",
        tags: []
      }
    ];

    // Alignment logic: Elphaba (bad) vs Glinda (good)
    const BAD_INDICATOR_TAGS = [
      "Suspicious",
      "Investigate",
      "SQLi",
      "Brute-force",
      "Privilege escalation"
    ];

    const GOOD_INDICATOR_TAGS = [
      "Benign"
    ];

    function getAlignment(log) {
      const tags = log.tags || [];
      const level = (log.level || "").toUpperCase();

      const isBad =
        BAD_INDICATOR_TAGS.some(t => tags.includes(t)) ||
        ["ERROR", "CRITICAL", "ALERT"].includes(level);

      const isGood =
        !isBad && GOOD_INDICATOR_TAGS.some(t => tags.includes(t));

      if (isBad) {
        return { label: "Elphaba", kind: "elphaba" };
      }
      if (isGood) {
        return { label: "Glinda", kind: "glinda" };
      }
      return null;
    }

    let logs = [...SAMPLE_LOGS];
    let selectedId = null;

    const searchInput = document.getElementById("searchInput");
    const levelFilter = document.getElementById("levelFilter");
    const tagFilter = document.getElementById("tagFilter");
    const onlyTagged = document.getElementById("onlyTagged");
    const logTableBody = document.getElementById("logTableBody");
    const fileInput = document.getElementById("fileInput");
    const sampleBtn = document.getElementById("sampleBtn");

    const selectionBadge = document.getElementById("selectionBadge");
    const emptyState = document.getElementById("emptyState");
    const detailContent = document.getElementById("detailContent");
    const detailTime = document.getElementById("detailTime");
    const detailLevel = document.getElementById("detailLevel");
    const detailSource = document.getElementById("detailSource");
    const detailCategory = document.getElementById("detailCategory");
    const detailMessage = document.getElementById("detailMessage");
    const detailTags = document.getElementById("detailTags");
    const tagInput = document.getElementById("tagInput");
    const addTagBtn = document.getElementById("addTagBtn");
    const statsLeft = document.getElementById("statsLeft");
    const statsRight = document.getElementById("statsRight");

    function getFilters() {
      return {
        text: searchInput.value.trim().toLowerCase(),
        level: levelFilter.value,
        tag: tagFilter.value,
        onlyTagged: onlyTagged.checked
      };
    }

    function formatTime(iso) {
      if (!iso) return "";
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    function applyFilters() {
      const { text, level, tag, onlyTagged } = getFilters();
      const taggedCounts = { Suspicious: 0 };
      let filtered = logs.filter(l => {
        if (level !== "ALL" && l.level !== level) return false;
        if (onlyTagged && (!l.tags || l.tags.length === 0)) return false;
        if (tag !== "ALL") {
          if (!l.tags || !l.tags.includes(tag)) return false;
        }
        if (text) {
          const hay = (
            (l.message || "") +
            " " + (l.source || "") +
            " " + (l.category || "") +
            " " + (l.level || "") +
            " " + (l.tags || []).join(" ")
          ).toLowerCase();
          if (!hay.includes(text)) return false;
        }
        if (l.tags && l.tags.includes("Suspicious")) {
          taggedCounts.Suspicious++;
        }
        return true;
      });

      return { filtered, taggedCounts };
    }

    function renderTable() {
      const { filtered, taggedCounts } = applyFilters();
      logTableBody.innerHTML = "";

      filtered.forEach(log => {
        const tr = document.createElement("tr");
        tr.dataset.id = log.id;
        if (log.id === selectedId) tr.classList.add("selected");

        const tdTime = document.createElement("td");
        tdTime.textContent = formatTime(log.timestamp);

        const tdLevel = document.createElement("td");
        const spanLevel = document.createElement("span");
        spanLevel.className = "level-pill level-" + (log.level || "INFO");
        spanLevel.textContent = log.level || "INFO";
        tdLevel.appendChild(spanLevel);

        const tdSrc = document.createElement("td");
        tdSrc.textContent = log.source || "-";

        const tdMsg = document.createElement("td");
        tdMsg.textContent = log.message || "";

        const tdTags = document.createElement("td");
        const alignment = getAlignment(log);

        if (alignment) {
          const pill = document.createElement("span");
          pill.className =
            "tag-pill " +
            (alignment.kind === "elphaba" ? "tag-elphaba" : "tag-glinda");
          pill.textContent = alignment.label;
          tdTags.appendChild(pill);
        } else if (log.tags && log.tags.length) {
          // fallback: show raw tags if no alignment
          log.tags.forEach(t => {
            const pill = document.createElement("span");
            pill.className = "tag-pill";
            pill.textContent = t;
            tdTags.appendChild(pill);
          });
        } else {
          const span = document.createElement("span");
          span.className = "muted";
          span.textContent = "‚Äî";
          tdTags.appendChild(span);
        }

        tr.appendChild(tdTime);
        tr.appendChild(tdLevel);
        tr.appendChild(tdSrc);
        tr.appendChild(tdMsg);
        tr.appendChild(tdTags);

        tr.addEventListener("click", () => {
          selectedId = log.id;
          renderTable();
          renderDetail();
        });

        logTableBody.appendChild(tr);
      });

      statsLeft.textContent = `${filtered.length} event${filtered.length === 1 ? "" : "s"}`;
      statsRight.textContent = `${taggedCounts.Suspicious || 0} suspicious on the road`;
    }

    function renderDetail() {
      const log = logs.find(l => l.id === selectedId);
      if (!log) {
        selectionBadge.textContent = "No event selected";
        emptyState.style.display = "block";
        detailContent.style.display = "none";
        return;
      }
      selectionBadge.textContent = log.id;
      emptyState.style.display = "none";
      detailContent.style.display = "block";

      detailTime.textContent = formatTime(log.timestamp);
      detailLevel.innerHTML = `<span class="level-pill level-${log.level}">${log.level}</span>`;
      detailSource.textContent = log.source || "-";
      detailCategory.textContent = log.category || "-";
      detailMessage.textContent = log.message || "";

      renderDetailTags(log);
    }

    function renderDetailTags(log) {
      detailTags.innerHTML = "";
      (log.tags || []).forEach(tag => {
        const pill = document.createElement("span");
        pill.className = "tag-pill";
        const label = document.createElement("span");
        label.textContent = tag;
        const remove = document.createElement("span");
        remove.className = "remove";
        remove.textContent = "‚úï";
        remove.addEventListener("click", (e) => {
          e.stopPropagation();
          log.tags = (log.tags || []).filter(t => t !== tag);
          renderTable();
          renderDetail();
        });
        pill.appendChild(label);
        pill.appendChild(remove);
        detailTags.appendChild(pill);
      });

      if (!log.tags || log.tags.length === 0) {
        const span = document.createElement("span");
        span.className = "muted";
        span.textContent = "No tags yet ‚Äî start the witchcraft! ‚ú®";
        detailTags.appendChild(span);
      }
    }

    function addTagToSelected(tag) {
      const t = tag.trim();
      if (!t) return;
      const log = logs.find(l => l.id === selectedId);
      if (!log) return;
      if (!log.tags) log.tags = [];
      if (!log.tags.includes(t)) {
        log.tags.push(t);
        tagInput.value = "";
        renderTable();
        renderDetail();
      }
    }

    function parseUploadedText(text) {
      const lines = text.split(/\r?\n/);
      const newLogs = [];
      let count = 0;

      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;

        let obj = null;
        if (trimmed.startsWith("{") && trimmed.endsWith("}")) {
          try {
            const parsed = JSON.parse(trimmed);
            obj = {
              id: "u-" + Date.now() + "-" + count,
              timestamp: parsed.timestamp || parsed.time || parsed["@timestamp"] || new Date().toISOString(),
              level: (parsed.level || parsed.severity || "INFO").toString().toUpperCase(),
              source: parsed.source || parsed.app || parsed.logger || "uploaded.jsonl",
              category: parsed.category || parsed.type || "Uploaded",
              message: parsed.message || parsed.msg || trimmed,
              tags: []
            };
          } catch {
          }
        }

        if (!obj) {
          const m = trimmed.match(/^(\S+\s+\d+\s+\d+:\d+:\d+|\d{4}-\d{2}-\d{2}T\S+Z?)?\s*(INFO|WARN|ERROR|CRITICAL|ALERT)?\s*([^:]+)?:?\s*(.*)$/i);
          let ts = new Date().toISOString();
          let level = "INFO";
          let source = "uploaded.log";
          let msg = trimmed;
          if (m) {
            if (m[1]) ts = m[1];
            if (m[2]) level = m[2].toUpperCase();
            if (m[3]) source = m[3].trim() || source;
            if (m[4]) msg = m[4];
          }
          obj = {
            id: "u-" + Date.now() + "-" + count,
            timestamp: ts,
            level,
            source,
            category: "Uploaded",
            message: msg,
            tags: []
          };
        }

        newLogs.push(obj);
        count++;
      }

      return newLogs;
    }

    searchInput.addEventListener("input", renderTable);
    levelFilter.addEventListener("change", renderTable);
    tagFilter.addEventListener("change", renderTable);
    onlyTagged.addEventListener("change", renderTable);

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const text = ev.target.result;
        const newLogs = parseUploadedText(text);
        logs = logs.concat(newLogs);
        renderTable();
      };
      reader.readAsText(file);
    });

    sampleBtn.addEventListener("click", () => {
      logs = [...SAMPLE_LOGS];
      selectedId = null;
      searchInput.value = "";
      levelFilter.value = "ALL";
      tagFilter.value = "ALL";
      onlyTagged.checked = false;
      renderTable();
      renderDetail();
    });

    addTagBtn.addEventListener("click", () => {
      addTagToSelected(tagInput.value);
    });

    tagInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addTagToSelected(tagInput.value);
      }
    });

    function init() {
      renderTable();
      renderDetail();
    }

    init();
  </script>
</body>
</html>